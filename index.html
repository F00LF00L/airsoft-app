<meta name='viewport' content='width=device-width, initial-scale=1'/>import React, { useState, useEffect } from 'react';
import { Timer, User, Shield, RotateCcw, Play, Pause, Settings, AlertTriangle, Clock, X } from 'lucide-react';

const App = () => {
  // Game Configuration & State
  const [gameStarted, setGameStarted] = useState(false);
  const [timeLeft, setTimeLeft] = useState(600); 
  const [initialTime, setInitialTime] = useState(600);
  const [respawnDuration, setRespawnDuration] = useState(30);
  const [scoreA, setScoreA] = useState(0);
  const [scoreB, setScoreB] = useState(0);
  const [showResetConfirm, setShowResetConfirm] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  
  // Players State (4 vs 4)
  const [teamA, setTeamA] = useState([
    { id: 1, name: "A1", respawning: false, timer: 0 },
    { id: 2, name: "A2", respawning: false, timer: 0 },
    { id: 3, name: "A3", respawning: false, timer: 0 },
    { id: 4, name: "A4", respawning: false, timer: 0 },
  ]);

  const [teamB, setTeamB] = useState([
    { id: 5, name: "B1", respawning: false, timer: 0 },
    { id: 6, name: "B2", respawning: false, timer: 0 },
    { id: 7, name: "B3", respawning: false, timer: 0 },
    { id: 8, name: "B4", respawning: false, timer: 0 },
  ]);

  // Countdown Timer Logic
  useEffect(() => {
    let interval;
    if (gameStarted && timeLeft > 0) {
      interval = setInterval(() => {
        setTimeLeft(prev => prev - 1);
      }, 1000);
    } else if (timeLeft === 0) {
      setGameStarted(false);
    }
    return () => clearInterval(interval);
  }, [gameStarted, timeLeft]);

  // Respawn Timers Logic
  useEffect(() => {
    const interval = setInterval(() => {
      const updateTeam = (team) => team.map(p => {
        if (p.respawning && p.timer > 0) {
          return { ...p, timer: p.timer - 1 };
        } else if (p.respawning && p.timer === 0) {
          return { ...p, respawning: false };
        }
        return p;
      });
      
      setTeamA(prev => updateTeam(prev));
      setTeamB(prev => updateTeam(prev));
    }, 1000);
    return () => clearInterval(interval);
  }, []);

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  const handleHit = (team, playerId) => {
    if (!gameStarted || timeLeft <= 0) return;

    if (team === 'A') {
      setScoreB(prev => prev + 1);
      setTeamA(prev => prev.map(p => p.id === playerId ? { ...p, respawning: true, timer: respawnDuration } : p));
    } else {
      setScoreA(prev => prev + 1);
      setTeamB(prev => prev.map(p => p.id === playerId ? { ...p, respawning: true, timer: respawnDuration } : p));
    }
  };

  const resetGame = () => {
    setScoreA(0);
    setScoreB(0);
    setTimeLeft(initialTime);
    setGameStarted(false);
    setTeamA(prev => prev.map(p => ({ ...p, respawning: false, timer: 0 })));
    setTeamB(prev => prev.map(p => ({ ...p, respawning: false, timer: 0 })));
    setShowResetConfirm(false);
  };

  const PlayerButton = ({ player, team, onHit }) => (
    <button 
      onClick={() => !player.respawning && onHit(team, player.id)}
      disabled={player.respawning || !gameStarted}
      className={`relative h-20 w-full rounded-2xl border transition-all flex flex-col items-center justify-center gap-1 overflow-hidden ${
        player.respawning 
          ? 'bg-zinc-900 border-red-900/50' 
          : 'bg-zinc-800 border-zinc-700 active:scale-95'
      } ${!gameStarted ? 'opacity-50' : ''}`}
    >
      {player.respawning ? (
        <>
          <span className="text-red-500 font-mono text-xl font-black">{player.timer}s</span>
          <span className="text-[10px] text-red-700 uppercase">Respawning</span>
          <div className="absolute bottom-0 left-0 h-1.5 bg-red-600 transition-all duration-1000" 
               style={{ width: `${(player.timer / respawnDuration) * 100}%` }} />
        </>
      ) : (
        <>
          <User size={20} className={team === 'A' ? 'text-blue-500' : 'text-orange-500'} />
          <span className="text-sm font-bold text-zinc-200">{player.name}</span>
        </>
      )}
    </button>
  );

  return (
    <div className="min-h-screen bg-black text-zinc-300 font-sans p-4 flex flex-col" dir="rtl">
      {/* Top Bar - Minimalist Score & Timer */}
      <div className="flex items-center justify-between mb-6 bg-zinc-900/80 p-4 rounded-3xl border border-zinc-800 sticky top-0 z-40 backdrop-blur-md">
        <div className="text-center min-w-[60px]">
          <div className="text-[10px] text-blue-500 font-bold uppercase">ALPHA</div>
          <div className="text-3xl font-black text-white leading-none">{scoreA}</div>
        </div>

        <div className="flex flex-col items-center">
          <div className={`text-2xl font-mono font-bold px-3 py-1 rounded-xl ${timeLeft < 60 && timeLeft > 0 ? 'text-red-500 animate-pulse' : 'text-zinc-100'}`}>
            {formatTime(timeLeft)}
          </div>
          <div className="flex gap-4 mt-2">
            <button onClick={() => setGameStarted(!gameStarted)} className="text-zinc-100 p-2 bg-zinc-800 rounded-full">
              {gameStarted ? <Pause size={20} fill="currentColor" /> : <Play size={20} fill="currentColor" />}
            </button>
            <button onClick={() => setShowSettings(true)} className="text-zinc-400 p-2">
              <Settings size={20} />
            </button>
          </div>
        </div>

        <div className="text-center min-w-[60px]">
          <div className="text-[10px] text-orange-500 font-bold uppercase">BRAVO</div>
          <div className="text-3xl font-black text-white leading-none">{scoreB}</div>
        </div>
      </div>

      {/* Grid of Players - Full Width for Mobile */}
      <div className="flex-1 space-y-8 pb-32">
        <div className="space-y-3">
          <div className="flex items-center gap-2 px-1">
            <Shield size={14} className="text-blue-500" />
            <span className="text-xs font-bold tracking-widest text-zinc-500">TEAM ALPHA</span>
          </div>
          <div className="grid grid-cols-2 gap-3">
            {teamA.map(p => <PlayerButton key={p.id} player={p} team="A" onHit={handleHit} />)}
          </div>
        </div>

        <div className="space-y-3">
          <div className="flex items-center gap-2 px-1">
            <Shield size={14} className="text-orange-500" />
            <span className="text-xs font-bold tracking-widest text-zinc-500">TEAM BRAVO</span>
          </div>
          <div className="grid grid-cols-2 gap-3">
            {teamB.map(p => <PlayerButton key={p.id} player={p} team="B" onHit={handleHit} />)}
          </div>
        </div>
      </div>

      {/* Floating Action Button for Reset */}
      <div className="fixed bottom-6 right-6 z-50">
        <button 
          onClick={() => setShowResetConfirm(true)}
          className="p-4 bg-zinc-900 border border-zinc-700 rounded-full text-zinc-400 shadow-2xl active:scale-90"
        >
          <RotateCcw size={24} />
        </button>
      </div>

      {/* Settings Panel */}
      {showSettings && (
        <div className="fixed inset-0 z-[100] flex flex-col bg-black/95 p-6 animate-in slide-in-from-bottom duration-300">
          <div className="flex justify-between items-center mb-8">
            <h2 className="text-2xl font-bold text-white">专转 砖拽</h2>
            <button onClick={() => setShowSettings(false)} className="p-2 bg-zinc-800 rounded-full"><X /></button>
          </div>

          <div className="space-y-8 overflow-y-auto">
            <section>
              <label className="flex items-center gap-2 text-zinc-400 mb-4 text-sm font-bold uppercase tracking-wider">
                <Clock size={16} />  砖拽 (拽转)
              </label>
              <div className="grid grid-cols-3 gap-2">
                {[5, 10, 15, 20, 30, 45].map(m => (
                  <button 
                    key={m} 
                    onClick={() => { setInitialTime(m * 60); setTimeLeft(m * 60); setGameStarted(false); }}
                    className={`py-3 rounded-xl border font-bold ${initialTime === m * 60 ? 'bg-white text-black border-white' : 'bg-zinc-900 border-zinc-800 text-zinc-400'}`}
                  >
                    {m}
                  </button>
                ))}
              </div>
            </section>

            <section>
              <label className="flex items-center gap-2 text-zinc-400 mb-4 text-sm font-bold uppercase tracking-wider">
                <RotateCcw size={16} />  专住驻 (砖转)
              </label>
              <div className="grid grid-cols-3 gap-2">
                {[10, 20, 30, 45, 60, 120].map(s => (
                  <button 
                    key={s} 
                    onClick={() => setRespawnDuration(s)}
                    className={`py-3 rounded-xl border font-bold ${respawnDuration === s ? 'bg-white text-black border-white' : 'bg-zinc-900 border-zinc-800 text-zinc-400'}`}
                  >
                    {s}
                  </button>
                ))}
              </div>
            </section>
          </div>

          <button 
            onClick={() => setShowSettings(false)}
            className="mt-auto w-full py-4 bg-blue-600 text-white rounded-2xl font-bold text-lg"
          >
            砖专 住专
          </button>
        </div>
      )}

      {/* Reset Confirmation */}
      {showResetConfirm && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/90 backdrop-blur-md">
          <div className="bg-zinc-900 border border-zinc-800 p-8 rounded-[2rem] w-full max-w-xs text-center">
            <div className="w-16 h-16 bg-red-900/20 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
              <AlertTriangle size={32} />
            </div>
            <h3 className="text-xl font-bold text-white mb-2">驻住 转?</h3>
            <p className="text-zinc-500 text-sm mb-8"> 转爪转  拽 爪转转.</p>
            <div className="flex flex-col gap-3">
              <button onClick={resetGame} className="w-full py-4 bg-red-600 text-white rounded-2xl font-bold">驻住 </button>
              <button onClick={() => setShowResetConfirm(false)} className="w-full py-4 bg-zinc-800 text-zinc-300 rounded-2xl font-bold"></button>
            </div>
          </div>
        </div>
      )}

      <style>{`
        body { background-color: #000; -webkit-tap-highlight-color: transparent; }
        .animate-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateY(100%); } to { transform: translateY(0); } }
      `}</style>
    </div>
  );
};

export default App;

entById('pickA').style.borderColor = t==='A' ? '#3b82f6' : '#27272a';
            document.getElementById('pickB').style.borderColor = t==='B' ? '#f97316' : '#27272a';
        };

        window.confirmEntry = () => {
            const name = document.getElementById('inputName').value.trim();
            if(!name || !activeTeamSelection) return;
            userLocal.name = name;
            userLocal.team = activeTeamSelection;
            localStorage.setItem('as_name', name);
            localStorage.setItem('as_team', activeTeamSelection);
            document.getElementById('loginScreen').classList.add('hidden');
            joinGame();
        };

        async function joinGame() {
            const ref = db.collection('airsoft_ultimate').doc(roomID);
            await ref.get().then(doc => {
                let d = doc.exists ? doc.data() : state;
                if(!d.adminId) d.adminId = userLocal.id;
                d.players[userLocal.id] = { name: userLocal.name, team: userLocal.team, end: 0 };
                d.ts = Date.now();
                ref.set(d);
            });
            updateUserLabel();
        }

        function updateUserLabel() {
            const isAdmin = state.adminId === userLocal.id;
            const el = document.getElementById('userLabel');
            el.innerText = (isAdmin ? " " : "") + `${userLocal.name}`;
            el.className = `text-[10px] font-black uppercase italic ${userLocal.team==='A'?'text-blue-500':'text-orange-500'}`;
            if(isAdmin) document.body.classList.add('is-admin');
        }

        async function connect() {
            try {
                await auth.signInAnonymously();
                db.collection('airsoft_ultimate').doc(roomID).onSnapshot(doc => {
                    if(doc.exists) {
                        const d = doc.data();
                        if(d.ts > state.ts || d.run !== state.run) state = d;
                    }
                    render();
                });
            } catch(e) {}
        }

        function render() {
            document.getElementById('txtScoreA').innerText = state.sA;
            document.getElementById('txtScoreB').innerText = state.sB;
            const m = Math.floor(state.time/60), s = state.time%60;
            document.getElementById('txtTimer').innerText = `${m}:${s<10?'0':''}${s}`;
            document.getElementById('iconPlay').innerHTML = state.run ? '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>' : '<path d="M8 5v14l11-7z"/>';
            document.getElementById('waitAdmin').style.display = state.run ? 'none' : 'block';
            
            updateUserLabel();
            renderGrids();
        }

        function renderGrids() {
            const alpha = document.getElementById('gridAlpha');
            const bravo = document.getElementById('gridBravo');
            alpha.innerHTML = ''; bravo.innerHTML = '';
            
            let countA = 0, countB = 0;
            const now = Date.now();

            Object.entries(state.players).forEach(([id, p]) => {
                const isDead = p.end > now;
                const isMe = id === userLocal.id;
                const card = document.createElement('div');
                card.className = `player-card glass ${isDead?'is-dead':''} ${isMe?'is-me':''} ${!state.run?'opacity-40':''}`;
                
                if(isDead) {
                    const sec = Math.ceil((p.end - now)/1000);
                    card.innerHTML = `<span class="text-3xl font-black italic">${sec}</span><span class="text-[8px] uppercase opacity-50 mt-1">${p.name}</span>`;
                } else {
                    card.innerHTML = `
                        <span class="text-[8px] font-black opacity-30 uppercase mb-1">Status: OK</span>
                        <span class="font-black text-sm uppercase ${p.team==='A'?'text-blue-500':'text-orange-500'}">${p.name}</span>
                    `;
                }

                card.onclick = () => {
                    if(!isMe || !state.run || isDead) return;
                    p.end = Date.now() + (state.resp * 1000);
                    if(p.team === 'A') state.sB++; else state.sA++;
                    sync();
                };

                // Admin functionality: Click to rename
                if(state.adminId === userLocal.id) {
                    card.oncontextmenu = (e) => {
                        e.preventDefault();
                        const newName = prompt(`砖 砖 注专 ${p.name}:`, p.name);
                        if(newName) { p.name = newName; sync(); }
                    };
                }

                if(p.team === 'A') { alpha.appendChild(card); countA++; }
                else { bravo.appendChild(card); countB++; }
            });

            document.getElementById('countA').innerText = `${countA} Active`;
            document.getElementById('countB').innerText = `${countB} Active`;
        }

        function sync() {
            state.ts = Date.now();
            db.collection('airsoft_ultimate').doc(roomID).set(state).catch(()=>{});
        }

        window.toggleHistory = () => {
            const p = document.getElementById('historyPanel');
            const isHidden = p.classList.contains('hidden');
            if(isHidden) {
                const list = document.getElementById('historyList');
                list.innerHTML = '';
                if(state.history.length === 0) {
                    document.getElementById('noHistory').classList.remove('hidden');
                } else {
                    document.getElementById('noHistory').classList.add('hidden');
                    state.history.slice().reverse().forEach(h => {
                        const div = document.createElement('div');
                        div.className = "glass p-6 rounded-2xl flex justify-between items-center border-white/5";
                        div.innerHTML = `
                            <div>
                                <p class="text-[10px] font-black text-zinc-500 uppercase">Round ${h.round}</p>
                                <p class="text-xs font-bold text-zinc-300">${new Date(h.ts).toLocaleTimeString()}</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="text-center"><span class="block text-[8px] text-blue-500 font-bold">ALPHA</span><span class="text-xl font-black">${h.sA}</span></div>
                                <div class="w-px h-8 bg-white/10"></div>
                                <div class="text-center"><span class="block text-[8px] text-orange-500 font-bold">BRAVO</span><span class="text-xl font-black">${h.sB}</span></div>
                            </div>
                            <div class="text-right">
                                <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase ${h.winner==='ALPHA'?'bg-blue-500/20 text-blue-500':'bg-orange-500/20 text-orange-500'}">${h.winner} WIN</span>
                            </div>
                        `;
                        list.appendChild(div);
                    });
                }
            }
            p.classList.toggle('hidden');
        };

        window.endRound = () => {
            if(!confirm(" 住 转 住 砖专 住专?")) return;
            const winner = state.sA > state.sB ? 'ALPHA' : (state.sB > state.sA ? 'BRAVO' : 'DRAW');
            state.history.push({
                round: state.history.length + 1,
                sA: state.sA,
                sB: state.sB,
                winner: winner,
                ts: Date.now()
            });
            state.sA = 0; state.sB = 0; state.time = 600; state.run = false;
            Object.values(state.players).forEach(p => p.end = 0);
            sync();
            toggleHistory();
        };

        window.createNewRoom = () => {
            const name = document.getElementById('newRoomName').value.trim().toLowerCase();
            if(!name) return;
            window.location.search = `?r=${name}`;
        };

        window.copyShareLink = () => {
            const temp = document.createElement('input');
            document.body.appendChild(temp);
            temp.value = window.location.href;
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            alert("拽砖专 专 注转拽!");
        };

        document.getElementById('btnMainToggle').onclick = () => {
            if(state.adminId !== userLocal.id) return;
            state.run = !state.run;
            sync();
        };

        setInterval(() => {
            if(state.run && state.time > 0) {
                state.time--;
                if(state.time === 0) endRound();
                render();
                if(state.time % 10 === 0) sync();
            }
        }, 1000);

        connect();
    </script>
</body>
</html>

